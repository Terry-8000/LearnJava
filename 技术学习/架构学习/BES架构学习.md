# BES架构学习 

## 分布式服务访问框架

这里使用的是DSF，业界比较著名的有Dubbo，其实原理都一样，大致分为4个角色：

1. **服务注册中心：**负责服务注册，服务发布，服务路由；
2. **服务提供方：**向服务中心注册，发布自己的服务；
3. **服务消费方：**订阅服务中心发布的服务，在服务中心notify服务之后，绑定并调用服务；
4. **服务监控方：**主要监控服务的调用情况。

DSF这个分布式服务调用框架中核心的调用路由，节点信息都保存在zookeeper上。

## API

我们的套件在DSF分布式服务调用框架上发布的所有对外服务接口，都可以通过UEE的gateway（网关，又称网间连接器、协议转换器）转化成标准的http restful服务(表征性状态转移[^1]是分布式应用服务器集群的一个要求，即服务的幂等性[^2]要求)。

## BDF

Business Development Framework，业务开发框架（JavaEE框架），也就是元数据引擎，提供了ORM（对象关系映射），OXM（XML对象映射），DI（依赖注入）等能力，还有BPM（业务流程管理），Microflow能力，终极目标是实现DDD（设计驱动开发）。

## DDS

分布式数据访问框架，业内著名的开源框架：阿里的Cobra。

当数据得到千万级别后，需要通过水平分表拆分为N个结构一样的表。这个时候就需要分布式数据访问框架了，提供的功能主要是：SQL执行计划，SQL执行，SQL结果汇聚等。

## NOSQL

非关系型数据库，有三种：key/value类型，比如Redis；文档类型，比如MongoDB；基于列类型，比如HBase。

## 分布式缓存

使用的是Redis，业界著名的还有Memcached，大都是基于一致性hash算法来实现分布式缓存内容命中。（可以看下一致性hash环算法https://blog.csdn.net/cywosp/article/details/23397179）

## 运维服务

ITPass提供：自动安装，升级，灰度发布，系统监控（负载，业务并发量，Tps（每秒事务量），吞吐量，时延等等），故障定位（提供服务调用链方便故障定位）。

## 负载均衡

#### 1. Radware

Radware提供硬件的负载均衡，能够实现传输层（IP+端口）级别的负载均衡。

负载均衡常用算法：

- 轮询：挨个来；
- 加权轮询：有一定权重的挨个来；
- 随机：按概率来说长期运行时平均的；
- 最少使用：分配给最少使用的；
- IP粘滞：同样的请求客户端IP，分配给最近最后依次请求的服务器。

#### 2. Nginx

反向代理服务器，接收网络上的请求然后再转发给内部网络上的服务器，在这里主要是应用层级别的负载均衡。

#### 3. varnish

与nginx仪器使用，起到了对服务器静态资源的缓存作用，比如一个静态页面请求到了nginx，nginx根据它自己的策略将次请求分发给varlish，从而直接返回静态资源，这样就极大的减轻了应用服务器集群的压力。

#### 4. zookeeper

Zookeeper类似于一棵节点树，当服务提供者启动时，将服务器的名称、地址以节点的信息添加到配置中心，而服务消费中通过服务器名称以及配置中心来获得需要调用的服务节点下的服务地址，再利用负载均衡算法选取其中的某一台服务器进行调用。

## jetMQ

基于RocketMQ封装的jetMQ。

## vSearch

搜索引擎。

## 高可用系统的5和核心点

一个好的，面向互联网海量高并发服务的系统架构，主要有5个核心的关注点：

1. 性能
2. 可用性
3. 伸缩性
4. 可拓展性 
5. 安全

### 1. 性能

性能的最主要的指标有三个：

- TPS：每秒事务量；
- 吞吐量：一段时间的系统总体事务量；
- 响应时长：系统一次调用的响应时间。

在性能/压力测试中，根据以上三个指标以及系统资源消耗快照（CPU占用率，内存占用率，硬盘IO，网络IO），通过关键路径打出线程时间戳，以此分析系统的瓶颈所在，从而分析出到底是**A，系统资源不足**，还是**B，代码实现有问题，**或者**C，系统架构有问题**。

系统性能的可优化点一般有四类：

#### 1.1 多级，分类的缓存

一个系统架构层面的缓存应该是多级存在的，并且由多种类型的缓存组成。**1. 浏览器缓存**，我们在写前台页面的时候，可以通过前台缓存将数据缓存在浏览器中。**2.CDN，**将服务器的一些静态资源（比如视频），放置在ISP供应商的CDN服务器上，能起到很好的缓存作用，之后请求分发到我们应用的机房侧。**3. Nginx+varnish（反向代理服务器+http cache），**将应用的静态资源（HTML，css，js，img）等放置到http cache上，之后请求用反向代理的软负载均衡发送到应用服务器集群上。命中**4. 应用服务器集群的本地缓存。**如果本地缓存中没有，请求**5，分布式缓存服务器（即远端缓存）**。最后都没有结果再访问**6. 数据库集群。**

**缓存数据的注意：**缓存的必须是读写比较高的热点数据，如果不是，使用缓存反而会给系统带来不必要的负担。

#### 1.2 多级负载均衡

首先在ISP供应商侧，**1. DNS，**通过域名解析将请求分发到两个不同的IP上。**2，RadWare，**硬件负载均衡器，通过IP+Port来对请求进行分发。**3，Nginx，**反向代理服务器，将部分静态资源的请求分发到Varnish上。**4. DFS/Ebus,**分布式服务调用框架，注册，管理应用服务器路由，将请求分发到提供同样服务的应用服务器上。

#### 1.3 消息队列

JetMQ，消息队列通过一部方式对高并发请求起到很好的削峰作用。

#### 1.4 代码编写注意

1. 多使用对象池技术，以减少对象创建维护的开销，比如线程池，连接池等等。
2. 并发，使用无锁算法以避免使用锁，如果必须使用则注意减少锁的使用范围，使用频率，同时考虑使用读写锁，线程可重入锁等等优化锁。
3. IO，磁盘IO注意使用缓存，减少读写次数，使用Raid。网络IO注意使用缓冲，压缩后发送，并合理的使用NIO取代BIO。
4. 注意异常的使用，异常对象的创建，抛出都是有相当的开销的，因此避免在循环或者高频调用的代码块使用异常。

### 2. 可用性

可用性的主要指标通过MTBF平均无故障时间（Mean Time Between Failures）来体现。系统架构的可用性主要通过服务和数据的冗余和故障切换来实现。

#### 2.1 服务+数据冗余

在架构的各个层面，通过应用服务器集群，缓存服务器集群，数据服务器集群等等来实现服务和数据的冗余。

#### 2.2 故障切换

首先描述应用服务器集群是如何故障切换的，之前介绍了分布式服务访问框架eBus。这个组件是构建在zookeeper之上的，发布到eBus上的服务是通过zookeeper的临时节点的方式记录在zookeeper的DFS（分布式文件系统）上的。这样，一旦一个应用服务器节点宕机，zookeeper的临时节点就会立即消失（这个是zookeeper的功能保证），同时触发一个回调事件，此时eBus就会删除这个节点的服务器路由和其他信息。这样之后的服务就不会再负载到宕机的应用服务器上。

### 3. 可伸缩性

一个合理的互联网系统架构，其服务网元必须是可弹性伸缩的。就是指在不改变应用服务能力的基础上，通过增加物理硬件，理论上能无限扩增系统的并发处理能力。同时反过来可以将服务缩减到最终只剩下一台物理服务节点。

### 4. 可拓展性

可拓展性指的是系统架构能在不影响原有功能的前提下，很容易的拓展新的业务。这个就要求整个系统的子系统（子模块）是高度解耦合的。本系统就是通过DSF/eBus这种服务注册，发现，绑定和调用的方式来实现各个套件的解耦的。



[^1]: 表征性状态转移就是Rest(Representational State Transfer)，[参考](https://www.cnblogs.com/liuning8023/archive/2012/07/12/2587878.html)
[^2]: 幂等性是指一次和多次请求某一个资源应该具有同样的作用，[参考](https://www.cnblogs.com/weidagang2046/archive/2011/06/04/2063696.html)