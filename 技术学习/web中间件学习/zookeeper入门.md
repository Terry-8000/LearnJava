# zookeeper入门

### 1. zookeeper是什么

zookeeper是一个分布式的应用程序协调服务，目的是通过协调应用程序提供给用户简单易用的接口和功能稳定的系统。

### 2. zookeeper提供了什么

- 文件系统

  每个子目录例如serviceName被称为znode，和文件系统一样，我们可以自由的增加、删除znode，唯一不同的是znode可以存储数据。有四种类型的znode：**持久化目录节点**、**持久化顺序编号目录节点**、**临时目录节点**、**临时顺序编号目录节点**。临时目录节点在客户端和zookeeper连接中断后删除。

- 通知系统

  客户端注册、监听它关心的目录节点，当目录节点发生变化（修改、删除、增加/删除子节点）时，zookeeper会通知客户端。

### 3. zookeeper做了什么

1. 命名服务

   其实就是我们常说的注册服务，在zookeeper的文件系统里创建一个目录，即有唯一的path。在我们无法确定上游程序的部署机器时即可与下游程序约定好path，通过path即能互相探索发现。

2. 配置管理

   程序是需要配置的，如果程序分散部署到多台机器上，要逐个改变配置就很困难。现在把这些配置放在zookeeper上，保存在zookeeper的某个目录节点上，然后每个相关的应用程序对这个目录节点进行监听，一旦配置信息发生改变，每个应用程序就会收到zookeeper的通知，然后从zookeeper获取新的配置信息应用到系统中。

3. 集群管理

   集群管理关注两点：是否有机器退出或者加入，选举master。首先解释一下什么是选举Master，集群管理是指管理多个提供服务的节点，一般集群采用master、slave的结构，一台主机多台备机，主机向外提供服务，备机负责监听主机的状态，一旦主机宕机，备机要迅速替代主机对外提供服务，从备机中选举一台作为主机的过程就是master选举。

   对于是否有机器退出或者加入，所有机器在父目录GroupMembers下创建临时目录节点，然后监听父目录中子节点变化的消息，一旦有机器挂掉，那么与zookeeper的连接中断，临时目录就会被删除，其他机器收到通知：某个兄弟目录被删除，说明它宕机了。

   对于选举Master，可以通过创建临时顺序目录节点，每次选取编号最小的作为Master即可。

4. 分布式锁

   锁服务可以分为两类，一个是保持独占，另一个是控制时序。 

   对于第一类，我们将zookeeper上的一个znode看作是一把锁，通过createznode的方式来实现。所有客户端都去创建 /distribute_lock 节点，最终成功创建的那个客户端也即拥有了这把锁。用完删除掉自己创建的distribute_lock 节点就释放出锁。 

   对于第二类， /distribute_lock 已经预先存在，所有客户端在它下面创建临时顺序编号目录节点，和选master一样，编号最小的获得锁，用完删除。

5. 队列管理

   两种类型的队列：

   1、同步队列，当一个队列的成员都聚齐时，这个队列才可用，否则一直等待所有成员到达。 

   2、队列按照 FIFO 方式进行入队和出队操作。 

   第一类，在约定目录下创建临时目录节点，监听节点数目是否是我们要求的数目。 

   第二类，和分布式锁服务中的控制时序场景基本原理一致，入列有编号，出列按编号。



> 参考：https://www.cnblogs.com/felixzh/p/5869212.html



